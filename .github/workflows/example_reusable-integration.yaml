name: Example Reusable Integration
on:
  workflow_dispatch:
  pull_request:
    branches: [main]

permissions:
  id-token: write
  contents: read
  attestations: write

# This workflow demonstrates the complete CI/CD pipeline using all reusable
# workflows from shared-workflows. It shows how to chain workflows together to
# create a production-ready artifact pipeline with build-info aggregation.
#
# WORKFLOW FLOW:
# 1. extract-version: Extract version from test file
# 2. build-packages: Build packages across multiple platforms using matrix strategy (uses reusable_execute-build.yaml)
# 3. package-built-artifacts: Package built artifacts into distributable formats (handles packaging in this example but could be done in the build step)
# 4. sign-artifacts: GPG sign the packaged artifacts for security (uses reusable_sign-artifacts.yaml)
# 5. deploy-artifacts: Deploy signed artifacts to JFrog Artifactory (uses reusable_deploy-artifacts.yaml)
# 6. create-release-bundle: Create a release bundle from deployed artifacts (uses reusable_create-release-bundle.yaml)
#
#
# USAGE:
# This example demonstrates best practices for integrating shared-workflows
# components into a complete CI/CD pipeline with build-info aggregation.
# =============================================================================

jobs:
  # Manual dispatches should not take arguments.
  extract-version:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Extract Version
        id: extract
        uses: aerospike/shared-workflows/.github/actions/extract-version-from-tag@v2.0.1
    outputs:
      version: ${{ steps.extract.outputs.version }}
      git_tag: ${{ steps.extract.outputs.git_tag }}
  # This is also an example of using a matrix strategy to build in GHA
  build-packages:
    uses: aerospike/shared-workflows/.github/workflows/reusable_execute-build.yaml@v2.0.0
    needs: extract-version
    # Matrix strategy: Multi-platform builds across Ubuntu/Debian/RPM families (x86_64 native, ARM64 emulated)
    strategy:
      matrix:
        include:
          # Ubuntu/Debian family (x86_64)
          - distro: jammy
            arch: x86_64
            runs-on: ubuntu-22.04
            emulated: false
          - distro: noble
            arch: x86_64
            runs-on: ubuntu-22.04
            emulated: false
    with:
      runs-on: ${{ matrix.runs-on }}
      jf-project: test
      jf-build-name: test-build
      jf-build-id: ${{ github.run_number }}-buildinfo-${{ matrix.distro }}-${{ matrix.arch }}
      gh-checkout-path: project-location # In the case of running in shared_workflows gh_checkout_path and gh_source_path will have the same content but we put them here by way of example.
      # gh-workflows-ref: v2.0.1  # Use specific shared-workflows version
      gh-source-path: repo-source
      build-script: |
        uname -m
        mkdir -p test-artifacts
        echo "Hello, World!" > test-artifacts/hello.txt
      gh-artifact-directory: build
      gh-artifact-name: build-artifacts-${{ matrix.distro }}-${{ matrix.arch }}
      gh-retention-days: 1 # default
      oidc-provider-name: gh-dev-test
      oidc-audience: aerospike/testing
      publish-build-info: true
      dry-run: false # default
  package-built-artifacts:
    needs: [build-packages, extract-version]
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 1
      - name: Download All Matrix Artifacts
        uses: actions/download-artifact@v4
        with:
          path: build-artifacts
          merge-multiple: true
      - name: Package Artifacts
        run: |
          echo "TODO add packaging"
      - name: Upload packaged
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: build-artifacts
          overwrite: true
          retention-days: 1
  sign-artifacts:
    needs: package-built-artifacts
    uses: aerospike/shared-workflows/.github/workflows/reusable_sign-artifacts.yaml@v2.0.0
    with:
      gh-retention-days: 1
      gh-artifact-name: build-artifacts
      # gh-workflows-ref: v2.0.1  # Use specific shared-workflows version
    secrets:
      gpg-private-key: ${{ secrets.GPG_SECRET_KEY }}
      gpg-public-key: ${{ secrets.GPG_PUBLIC_KEY }}
      gpg-key-pass: ${{ secrets.GPG_PASS }}

  deploy-artifacts:
    needs: [sign-artifacts, extract-version]
    uses: aerospike/shared-workflows/.github/workflows/reusable_deploy-artifacts.yaml@v2.0.0
    with:
      jf-project: test
      jf-build-name: test-build
      jf-metadata-build-id: ${{ github.run_number }}-buildinfo
      jf-build-id: ${{ github.run_number }}
      gh-artifact-name: ${{ needs.sign-artifacts.outputs.gh-artifact-name }}
      version: ${{ needs.extract-version.outputs.version }}
      gh-retention-days: 1
      oidc-provider-name: gh-dev-test
      oidc-audience: aerospike/testing
      dry-run: true
  create-release-bundle:
    needs: [package-built-artifacts, extract-version, deploy-artifacts]
    uses: aerospike/shared-workflows/.github/workflows/reusable_create-release-bundle.yaml@v2.0.0
    if: github.event_name == 'workflow_dispatch'
    with:
      jf-project: test
      jf-build-names: test-build:${{ github.run_number }},test-build-container:${{ github.run_number }}
      jf-bundle-name: test-release
      version: ${{ needs.extract-version.outputs.version }}
      # gh-workflows-ref: v2.0.1  # Use specific shared-workflows version
      oidc-provider-name: gh-dev-test
      oidc-audience: aerospike/testing
      dry-run: true
